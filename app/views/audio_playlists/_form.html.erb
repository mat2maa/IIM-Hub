<%= minimal_form_for @audio_playlist,
                     html: {class: 'form-vertical', multipart: true} do |f| %>

  <div class="span3">
    <div class="content">
      <% if @audio_playlist.user_id.present? %>
        <div class="info info-title">Programmer</div>
        <div class="info-list">
          <ul>
            <li class="info"><%= @audio_playlist.user.login.titleize if !@audio_playlist.user_id.nil? %>&nbsp;</li>
          </ul>
        </div>
        <br>
      <% end %>
      <% if controller.action_name != 'new' %>
        <div class="info info-title">Tools</div>
        <div class="info-list">
          <ul>
            <li class="info">
              <%= link_to "Print Playlist",
                          {controller: "audio_playlists",
                           action: "show",
                           id: @audio_playlist},
                          id: 'print_playlist',
                          target: '_blank' %>
            </li>
            <li class="info">
              <%= link_to "Export as Excel",
                          controller: "audio_playlists",
                          action: "export_to_excel",
                          id: @audio_playlist %>
            </li>
          </ul>
        </div>
        <br>

        <div class="info info-title">
          Audio Player
          <div class="audio-loader pull-right" style="display: none;">
            <%= image_tag 'loading-indicator.gif',
                          id: 'loading-indicator',
                          class: 'transparent' %>
          </div>
        </div>
        <div class="info-list">
          <ul>
            <li class="info">
              <audio controls>
                <source src="" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            </li>
          </ul>
        </div>
        <br>

        <div class="info info-title">
          Downloader
          <div class="btn-group pull-right">
            <%= link_to 'Tasks',
                        '/delayed_job',
                        target: '_blank',
                        class: 'btn btn-mini btn-info' %>
          </div>
        </div>
        <div class="info-list download-info">
          <ul>
            <li class="info">
              <div class="download-info-inner">
                <%= link_to 'Create Playlist Zip',
                            download_audio_playlist_path(@audio_playlist.id),
                            id: 'download_playlist_link' %>
              </div>
            </li>
            <li class="info download-link">
              <% if @audio_playlist.finished? %>
                <div class="download-info-inner">
                  <%= link_to "Download Playlist Zip", @audio_playlist.audio_playlist_zip.url %>
                </div>
              <% end %>
            </li>
            <li class="info message">
            </li>
            <li class="info download-progress">
            </li>
            <li class="info">
              <div class="download-info-inner">
                <div class="progress progress-striped active progress-bar-outer">
                  <div class="progress-bar bar" style="width:0%; height: 20px;"></div>
                </div>
              </div>
            </li>
          </ul>
        </div>
        <br>

      <% end %>
    </div>
    <!--end of .content-->
  </div>
  <!--end of .span-->

  <div class="span6">
    <div class="content">
      <% if controller.action_name != 'new' %>
        <div class="tabbable">
          <ul class="nav nav-tabs pre-nav-below">
            <li>
              <%= link_to "Previous",
                          edit_audio_playlist_path(@audio_playlist.previous.id) if @audio_playlist.previous.present? %>
            </li>
            <li>
              <%= link_to "Next",
                          edit_audio_playlist_path(@audio_playlist.next.id) if @audio_playlist.next.present? %>
            </li>
            <li>
              <%= link_to 'View Audio Playlist',
                          audio_playlist_path(@audio_playlist) %>
            </li>
            <li>
              <%= link_to "New Audio Playlist",
                          new_audio_playlist_path %>
            </li>
            <% if permitted_to? :admin_delete,
                                :audio_playlists %>
              <li>
                <%= link_to 'Delete',
                            audio_playlist_url(@audio_playlist),
                            method: :delete,
                            confirm: 'Are you sure?' %>
              </li>
            <% end %>
          </ul>
        </div>

        <br>

      <% end %>

      <div class="controls controls-row">
        <div class="row input_field_labels">
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.client_playlist_code, 'Client Playlist Code' %></div>
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.airline_id, 'Airline' %></div>
        </div>
        <%= f.input_field :client_playlist_code,
                          placeholder: 'Client Playlist Code',
                          class: 'span3' %>

        <%= render partial: 'application/bootstrap_prepend_select',
                   locals: {f: f,
                            field: :airline_id,
                            link_path: airlines_path,
                            collection: Airline.order("code asc").collect { |p| [p.code + " - " + p.name, p.id] },
                            placeholder: 'Airline',
                            span: 'span3'} %>
      </div>

      <div class="controls controls-row">
        <div class="row input_field_labels">
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.start_playdate, 'Play Date Start' %></div>
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.end_playdate, 'Play Date End' %></div>
        </div>
        <%= render partial: 'application/bootstrap_append_datepicker',
                   locals: {f: f,
                            field: :start_playdate,
                            value: @audio_playlist.start_playdate,
                            input_id: 'start_playdate_datepicker',
                            date_format: 'mm/yyyy',
                            date_viewmode: 'months',
                            date_minviewmode: 'months',
                            datepicker_behaviour: 'datepicker-months',
                            placeholder: 'Play Date Start',
                            span: 'span3'} %>

        <%= render partial: 'application/bootstrap_append_datepicker',
                   locals: {f: f,
                            field: :end_playdate,
                            value: @audio_playlist.end_playdate,
                            input_id: 'end_playdate_datepicker',
                            date_format: 'mm/yyyy',
                            date_viewmode: 'months',
                            date_minviewmode: 'months',
                            datepicker_behaviour: 'datepicker-months',
                            placeholder: 'Play Date End',
                            span: 'span3'} %>
      </div>

      <div class="controls controls-row">
        <div class="row input_field_labels">
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.program_id, 'Programme' %></div>
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.vo_id, 'VO' %></div>
        </div>
        <%= render partial: 'application/bootstrap_prepend_select',
                   locals: {f: f,
                            field: :program_id,
                            link_path: programs_path,
                            collection: Program.connection.execute(Program.select('name, id').order("name asc").to_sql).to_a,
                            placeholder: 'Programme',
                            span: 'span3'} %>

        <%= render partial: 'application/bootstrap_prepend_select',
                   locals: {f: f,
                            field: :vo_id,
                            link_path: vos_path,
                            collection: Vo.connection.execute(Vo.select('name, id').order("name asc").to_sql).to_a,
                            placeholder: 'VO',
                            span: 'span3'} %>
      </div>

      <div class="controls controls-row">
        <div class="row input_field_labels">
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.in_out, 'In/Out' %></div>
          <div class="input_field_label span3"><%= input_field_label @audio_playlist.airline_duration, 'Airline Duration' %></div>
        </div>
        <%= f.input_field :in_out,
                          as: :select,
                          collection: in_out,
                          include_blank: true,
                          class: 'select2 span3',
                          placeholder: 'In/Out' %>

        <%= f.input_field :airline_duration,
                          as: :select,
                          collection: Split.connection.execute(Split.select('name, duration').order(:duration).to_sql).to_a,
                          include_blank: true,
                          class: 'select2 span3',
                          placeholder: 'Airline Duration' %>
      </div>

      <div class="controls controls-row">
        <% if controller.action_name != 'new' %>
          <%= render partial: 'duration',
                     object: @audio_playlist %>
        <% end %>
        <%= f.button :submit, class: 'btn span3' %>
      </div>

      <br>

      <% if controller.action_name != 'new' %>
        <!-- Button to trigger modal -->
        <%= link_to 'Add Track',
                    add_track_to_playlist_path(id: @audio_playlist.id),
                    id: 'add_track_to_playlist_hidden',
                    class: 'btn hidden-input',
                    role: 'btn',
                    data: {toggle: 'modal', target: '#ajax-modal'} %>
      <% end %>

      <br><br>

    </div>
    <!--end of .content-->
  </div>
  <!--end of .span-->
<% end %>

<% if controller.action_name != 'new' %>
  <%= content_for :playlist do %>
    <div class="info info-title">
      Playlist
      <div class="btn-group pull-right" id="table-column-select">
        <!-- Button to trigger modal -->
        <button id="add_track_to_playlist" type="button" class="btn btn-mini btn-info" onclick="$('#add_track_to_playlist_hidden').click();">Add
          Track
        </button>
        <a class="btn btn-mini btn-info dropdown-toggle" data-toggle="dropdown" href="#">
          Select Columns
          <span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
          <% @columns.each.with_index do |column, index| %>
            <li><%= check_box_tag column,
                                  column,
                                  session[:audio_playlist_checked].present? ? session[:audio_playlist_checked][index] == 'true' : true %> <%= column %></li>
          <% end %>
          <li>&nbsp;</li>
        </ul>
      </div>
    </div>
    <div id="playlist">
      <%= render partial: 'playlist',
                 object: @audio_playlist %>
    </div>
  <% end %>

  <%= content_for :modal do %>
    <%= render 'modal' %>
  <% end %>

  <% content_for(:head) do %>
    <meta name="pdfkit-orientation" content="Landscape"/>
    <script>
      jQuery(document).ready(function () {
        jQuery('#print_playlist').click(function (event) {
          if (!confirm("ALERT! Please change your page layout to LANDSCAPE when printing")) {
            event.preventDefault();
          }
        });
      });
    </script>
  <% end %>

  <script type="text/javascript">

    var $ = jQuery;

    // this sets up the ajax loader, and it will stay until the method specific js removes it
    $('a[data-target=#ajax-modal]').on('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      $('body').modalmanager('loading');
      $.rails.handleRemote($(this));
    });

    // removes whatever is in the modal body content div upon clicking close/outside modal
    $(document).on('click', '[data-dismiss=modal], .modal-scrollable', function (e) {
      $('.modal-body-content').empty();
    });

    $(document).on('click', '#ajax-modal', function (e) {
      e.stopPropagation();
    });

    // Table column select
    $(document)
        .on('click', '#table-column-select ul li input', function (e) {
          e.stopPropagation();
        })
        .on('change', '#table-column-select ul li input', function (e) {

          var checked = $(this).is(":checked");

          var index = $(this).parent().index();

          if (checked) {
            $('#playlist table thead th').eq(index).show();
            $('#playlist table thead th').eq(index).attr('data-display', 'visible');
          } else {
            $('#playlist table thead th').eq(index).hide();
            $('#playlist table thead th').eq(index).attr('data-display', 'none');
          }

          $('#playlist table tbody tr').each(function () {
            if (checked) {
              $(this).find("td").eq(index).show();
              $(this).find("td").eq(index).attr('data-display', 'visible');
            } else {
              $(this).find("td").eq(index).hide();
              $(this).find("td").eq(index).attr('data-display', 'none');
            }
          });

          var checkedVals = $('#table-column-select ul li input').map(function () {
            return $(this).prop('checked');
          }).get();

          console.log(checkedVals);

          $.ajax({
            url: '/audio_playlists/table_column_select',
            type: 'post',
            data: { checked: checkedVals }
          });
        });

    var $ = jQuery,
        DownloadPoller;

    DownloadPoller = {
      poll: function () {
        setTimeout(this.request, 3000);
      },
      request: function () {
        $.ajax({
          url: '/poll_audio_playlist_download_data/<%= @audio_playlist.id %>',
          type: 'get',
          dataType: 'script'
        });
      }
    };

    $(function () {
      $(document).on("click", "#download_playlist_link", function (e) {
        e.preventDefault();

        $.ajax({
          url: '/download_audio_playlist/<%= @audio_playlist.id %>',
          type: 'get',
          dataType: 'script'
        });

        DownloadPoller.poll();

      });
    });

  </script>
<% end %>
