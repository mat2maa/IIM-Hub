// Place your application-specific JavaScript functions and classes here
// This file is automatically included by javascript_include_tag :defaults

jQuery.noConflict();

jQuery.ajaxSetup({
  'beforeSend': function (xhr) {
    xhr.setRequestHeader("Accept", "text/javascript")
  }
});

function remove_fields(link) {
  $(link).previous("input[type=hidden]").value = "1";
  $(link).up(".fields").hide();
}

function add_fields(link, association, content) {
  var new_id = new Date().getTime();
  var regexp = new RegExp("new_" + association, "g")
  $(link).up().insert({
    before: content.replace(regexp, new_id)
  });
}

jQuery.fn.submitWithAjax = function () {
  this.unbind('submit', false);
  this.submit(function () {
    jQuery.post(this.action, jQuery(this).serialize(), null, "script");
    return false;
  })

  return this;
};

//This will "ajaxify" the links
function ajaxLinks() {
  jQuery('.ajaxForm').submitWithAjax();
}

var $ = jQuery;

Modernizr.addTest('csscalc', function () {
  var prop = 'width:';
  var value = 'calc(10px);';
  var el = document.createElement('div');

  el.style.cssText = prop + Modernizr._prefixes.join(value + prop);

  return !!el.style.length;
});

function calcFallback() {
  $('.row-fluid .prepend-select2 + .select2-container.span12, .row-fluid .prepend-select2 + input + .select2-container.span12, .row-fluid .calendar input.span12').css('width', '100%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span11, .row-fluid .prepend-select2 + input + .select2-container.span11, .row-fluid .calendar input.span11').css('width', '91.48936170212765%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span10, .row-fluid .prepend-select2 + input + .select2-container.span10, .row-fluid .calendar input.span10').css('width', '82.97872340425532%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span9, .row-fluid .prepend-select2 + input + .select2-container.span9, .row-fluid .calendar input.span9').css('width', '74.46808510638297%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span8, .row-fluid .prepend-select2 + input + .select2-container.span8, .row-fluid .calendar input.span8').css('width', '65.95744680851064%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span7, .row-fluid .prepend-select2 + input + .select2-container.span7, .row-fluid .calendar input.span7').css('width', '57.44680851063829%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span6, .row-fluid .prepend-select2 + input + .select2-container.span6, .row-fluid .calendar input.span6').css('width', '48.93617021276595%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span5, .row-fluid .prepend-select2 + input + .select2-container.span5, .row-fluid .calendar input.span5').css('width', '40.42553191489362%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span4, .row-fluid .prepend-select2 + input + .select2-container.span4, .row-fluid .calendar input.span4').css('width', '31.914893617021278%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span3, .row-fluid .prepend-select2 + input + .select2-container.span3, .row-fluid .calendar input.span3').css('width', '23.404255319148934%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span2, .row-fluid .prepend-select2 + input + .select2-container.span2, .row-fluid .calendar input.span2').css('width', '14.893617021276595%').css('width', '-=37px');
  $('.row-fluid .prepend-select2 + .select2-container.span1, .row-fluid .prepend-select2 + input + .select2-container.span1, .row-fluid .calendar input.span1').css('width', '6.382978723404255%').css('width', '-=37px');
  if ($(window).width() < 980) {
    $('.prepend-select2 + .select2-container[class*="span"], .prepend-select2 + input + .select2-container[class*="span"], .calendar input[class*="span"]').css('width', '100%').css('width', '-=39px');
    $('.input-append.file-input input[type="text"]').css('width', '100%').css('width', '-=39px');
  } else {
    $('.prepend-select2 + .select2-container[class*="span"], .prepend-select2 + input + .select2-container[class*="span"], .calendar input[class*="span"]').not($('.search-form').find($('.prepend-select2 + .select2-container[class*="span"], .prepend-select2 + input + .select2-container[class*="span"], .calendar input[class*="span"]'))).width("");
    $('.input-append.file-input input[type="text"]').not($('.search-form').find($('.input-append.file-input input[type="text"]'))).width("");
  }
  if ($(window).width < 768) {
    $('#movie_poster_input').css('width', '100%').css('width', '-=37px');
  } else {
    $('#movie_poster_input').not($('.search-form').find($('#movie_poster_input'))).width("");
  }
}

$(document).ready(function () {

      if (Modernizr.csscalc) {
      } else {
        calcFallback();
      }

      $(window).resize(function() {
        if (Modernizr.csscalc) {
        } else {
          calcFallback();
        }
      });

      $('*').on('shown', function() {
        if (Modernizr.csscalc) {
        } else {
          calcFallback();
        }
      });

      // All non-GET requests will add the authenticity token
      // if not already present in the data packet
      $(document).ajaxSend(function (event, request, settings) {
        if (typeof(window.AUTH_TOKEN) == "undefined") return;
        // <acronym title="Internet Explorer 6">IE6</acronym> fix for http://dev.jquery.com/ticket/3155
        if (settings.type == 'GET' || settings.type == 'get') return;
        settings.data = settings.data || "";
        settings.data += (settings.data ? "&" : "") + "authenticity_token=" + encodeURIComponent(window.AUTH_TOKEN);
      });
      ajaxLinks();

      //Best In Place Gem Init
      $('.best_in_place').best_in_place();

      //jQuery UI Sortable and Mixonic Ranked-Model to sort and submit playlist orders
      var item_id,
          position,
          url;

      $(".sort-list").sortable({
        axis: 'y',
        containment: 'parent',
        cursor: 'crosshair',
        items: 'tr.sortable',

        stop: function (e, ui) {
          ui.item.children('td').effect('highlight', {}, 1000);
          ui.item.children('td[data-display="none"]').css('display', 'none');
        },
        update: function (e, ui) {
          item_id = ui.item.attr('data-id');
          position = ui.item.index();
          url = $(this).attr('data-url');
          console.log(item_id + " " + position + " " + url);
          $.ajax({
            type: 'POST',
            url: $(this).data('url'),
            dataType: 'json',

            //the :thing hash gets passed to @thing.attributes
            data: {
              id: item_id,
              position_position: position
            }
          });
        }
      });

      $(".album-sort-list").sortable({
        axis: 'y',
        containment: 'parent',
        cursor: 'crosshair',
        items: 'tr.sortable',

        stop: function (e, ui) {
          ui.item.children('td').effect('highlight', {}, 1000);
          ui.item.children('td[data-display="none"]').css('display', 'none');
        },
        update: function (e, ui) {
          item_id = ui.item.attr('data-id');
          position = ui.item.index();
          url = $(this).attr('data-url');
          console.log(item_id + " " + position + " " + url);
          $.ajax({
            type: 'POST',
            url: $(this).data('url'),
            dataType: 'json',

            //the :thing hash gets passed to @thing.attributes
            data: {
              id: item_id,
              track_num_position: position
            }
          });
        }
      });

      //Auto-completing sections of the movies form based on selected inputs
      $('#movie_movie_type_id').on("change", function () {
        $('#movie_language_tracks_input').find('input').prop('checked', false);
        var movieType = $(this).val();

        /*
         14 Arabic Movie
         3 Cantonese Movie
         19 Danish Movie
         15 Dutch Movie
         17 Finnish Movie
         2 French Movie
         7 German Movie
         21 Hebrew Movie
         12 Hindi Movie
         1 Hollywood Movie
         9 Italian Movie
         5 Japanese Movie
         4 Korean Movie
         23 Malay Movie
         6 Mandarin Movie
         18 Norwegian Movie
         20 Persian Movie
         16 Portuguese Movie
         10 Russian Movie
         8 Spanish Movie
         13 Swedish Movie
         22 Thai Movie
         */

        switch (movieType) {
          case "1" :
            $('#movie_foreign_language_title').val("");
            $('#movie_foreign_language_title').prop('disabled', true);
            $('#movie_language_tracks_eng').prop('checked', true);
            break;
          case "3" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_zho').prop('checked', true);
            break;
          case "14" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_ara').prop('checked', true);
            break;
          case "19" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_dan').prop('checked', true);
            break;
          case "15" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_ndl').prop('checked', true);
            break;
          case "17" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_fin').prop('checked', true);
            break;
          case "2" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_fra').prop('checked', true);
            break;
          case "7" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_deu').prop('checked', true);
            break;
          case "21" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_heb').prop('checked', true);
            break;
          case "12" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_hin').prop('checked', true);
            break;
          case "9" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_ita').prop('checked', true);
            break;
          case "5" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_jpn').prop('checked', true);
            break;
          case "4" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_kor').prop('checked', true);
            break;
          case "23" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_msa').prop('checked', true);
            break;
          case "6" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_zho').prop('checked', true);
            break;
          case "18" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_nor').prop('checked', true);
            break;
          case "20" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_fas').prop('checked', true);
            break;
          case "16" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_por').prop('checked', true);
            break;
          case "10" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_ru').prop('checked', true);
            break;
          case "8" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_spa').prop('checked', true);
            break;
          case "13" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_swe').prop('checked', true);
            break;
          case "22" :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_tha').prop('checked', true);
            break;
          default :
            $('#movie_foreign_language_title').prop('disabled', false);
            $('#movie_language_tracks_eng').prop('checked', false);
            break;
        }
      });

      $('#movie_screener_remarks').on("change", function () {
        if ($.inArray("Other", $('#movie_screener_remarks').val()) !== -1) {
          $('#movie_screener_remarks_other').prop('disabled', false);
        } else {
          $('#movie_screener_remarks_other').prop('disabled', true);
        }
      });

      $('#movie_airline_rights').on("change", function () {
        var airlineRights = $(this).val();
        switch (airlineRights) {
          case "North America" :
            $('#movie_airline_countries').prop('disabled', true);
            break;
          case "Worldwide" :
            $('#movie_airline_countries').prop('disabled', true);
            break;
          default :
            $('#movie_airline_countries').prop('disabled', false);
            break;
        }
      });

      // Remote pagination links for UI Dialog forms
      $('body').on('click', '.modal .pagination a', function () {
        $.rails.handleRemote($(this));
        return false;
      });

      // Show and hide "working" spinner
      $(".spinner-trigger[data-remote='true']")
          .on("ajax:beforeSend", function () {
            $('#spinner').removeClass('transparent');
            console.log("on");
          })
          .on("ajax:ajaxComplete", function () {
            $('#spinner').addClass('transparent');
            console.log("off");
          })

      $('input[type="file"]').attr("size", 6);

      // enable chosen js
      $('.select2').select2({
        allowClear: true
      });

      // initialize datepicker for different date formats
      $('[data-behaviour~=datepicker-days]').closest('.input-append.date').datepicker({
        format: "yyyy-mm-dd",
        viewMode: "days",
        minViewMode: "days",
        autoclose: true
      });

      $('[data-behaviour~=datepicker-months]').closest('.input-append.date').datepicker({
        format: "yyyy-mm-dd",
        viewMode: "months",
        minViewMode: "months",
        autoclose: true
      });

      $('[data-behaviour~=datepicker-years]').closest('.input-append.date').datepicker({
        format: "yyyy",
        viewMode: "years",
        minViewMode: "years",
        autoclose: true
      });

      $('.wysihtml5').each(function (i, elem) {
        $(elem).wysihtml5();
      });

      $('.select2-offscreen').each(function () {
        var val = $(this).select2("val");
        $(this).data("val", val);
      });


      $(document).on("click", '.form-reset', function () {
        $(this).closest('form').find('.select2-offscreen').each(function () {
          $(this).select2("val", $(this).data("val"));
        });
      });

      var src,
          $audioPlayer;
      $(document).on("click", '.btn-play', function (e) {
        e.preventDefault();
        src = $(this).attr('data-src');
        $audioPlayer = $('audio').get(0);
        $audioPlayer.src = src;
        $audioPlayer.play();
      });

    }
)
;
